@{
    ViewData["Title"] = "Bitcoin Timeline";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-sm-3 col-lg-2">
            <nav class="navbar navbar-inverse navbar-fixed-side" style="background-color:#2e3336;color:white;">
                <img src="~/images/logo.png" style="width:220px;" />

                <div class="collapse navbar-collapse" id="event-type-list">
                </div>
            </nav>
        </div>
        <div class="col-sm-9 col-lg-10">
            <br />
            <div class="row">
                <div class="col-xs-12">
                    <div id="visualization" style="height:300px;">
                        No Data To Display
                    </div>
                </div>
                <div class="col-xs-12" align="right" style="padding-top:5px;">
                    <button type="button" id="zoomIn" class="btn btn-sm btn-primary">
                        <span class="glyphicon glyphicon-plus-sign" aria-hidden="true"></span>
                    </button>
                    <button type="button" id="zoomOut" class="btn btn-sm btn-primary">
                        <span class="glyphicon glyphicon-minus-sign" aria-hidden="true"></span>
                    </button>
                    <button type="button" id="moveLeft" class="btn btn-sm btn-primary">
                        <span class="glyphicon glyphicon-menu-left" aria-hidden="true"></span>
                    </button>
                    <button type="button" id="moveRight" class="btn btn-sm btn-primary">
                        <span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span>
                    </button>
                </div>

            </div>
            <hr />
            <div class="row">
                <div class="col-xs-4">
                    <div class="form-group">
                        <button onclick="doFilter()" class="btn btn-default btn-primary" style="width:100%">Run!</button>
                    </div>
                    <div class="form-group">
                        <div style="height:200px;" id="filter">
                        </div>
                    </div>

                </div>
                <div class="col-xs-8">
                    <div id="state-details">
                        <div style="font-weight:bold;text-align:center;">
                            <span class="glyphicon glyphicon-chevron-up" aria-hidden="true"></span>
                            Click on a timeline item to view event state data.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script id="state-template" type="text/x-handlebars-template">
        <div class="entry">
            <span style="font-weight:bold;">{{id}}</span>
            <div>
                Time: {{on}}
            </div>
            <hr />
            <div style="height:200px;overflow:auto;">
                <table class="table">
                    {{#each stateValues}}
                    <tr>
                        <td>{{key}}</td>
                        <td>{{{value}}}</td>
                    </tr>
                    {{/each}}
                </table>
            </div>
        </div>
    </script>

    <script id="event-type-template" type="text/x-handlebars-template">
        <ul class="nav navbar-nav">
            <li class="dropdown-header">
                <h4>Event Types</h4>
                <ul class="dropdown-menu">
                    {{#each eventTypes}}
                    <li><label><input type="checkbox" /> {{this}}</label></li>
                    {{/each}}
                </ul>
            </li>
            </ul>
        </ul>
    </script>



    <div class="modal fade" id="about" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">Chronicity Timeline Example</h4>
                </div>
                <div class="modal-body">
                    ...
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">


        var container = document.getElementById('visualization');
        var options = { height: '300px' };

        var stateTemplateSource = document.getElementById("state-template").innerHTML;
        var stateTemplate = Handlebars.compile(stateTemplateSource);

        var eventTypeTemplateSource = document.getElementById("event-type-template").innerHTML;
        var eventTypeTemplate = Handlebars.compile(eventTypeTemplateSource);

        var timeline;

        function doFilter() {

            $(container).html('');

            var filters = JSON.parse(editor.getValue());

            $.ajax({
                type: "POST",
                url: '/api/Data',
                dataType: 'json',
                contentType: 'application/json',
                data: JSON.stringify(filters),
                success: function (data) {
                    var items = new vis.DataSet(data);
                    timeline = new vis.Timeline(container, items, options);
                    timeline.on('select', onSelect);
                    timeline.zoomIn(1);
                }
            });

        }

        function onSelect(properties) {
            $.ajax({
                type: "GET",
                url: '/api/Data/?id=' + properties.items[0],
                dataType: 'json',
                contentType: 'application/json',
                success: function (data) {
                    var html = stateTemplate(data);
                    $('#state-details').html(html);
                }
            });
        }

        var editor = ace.edit("filter");
        editor.setTheme("ace/theme/chrome");
        editor.getSession().setMode("ace/mode/json");
        editor.resize();


        function runPreset(id) {

            var preset = new Array();
            preset[0] = ["On.Between=2016/1/01,2017/12/31", "Type=Headline"];
            preset[1] = ["On.Between=2017/1/01,2017/12/31"];
            preset[2] = ["On.Between=2017/1/01,2017/10/01", "Entity.State.Increase=True"];
            preset[3] = ["On.Between=2017/1/01,2017/10/01", "Entity.State.Increase=False"];


            var selectedPreset = { "filters": preset[id] };

            var formatted = JSON.stringify(selectedPreset, null, '\t');

            editor.setValue(formatted, 1);
            doFilter();

        }

        function showAbout() {
            $('#about').modal('show')
        }

        function move(percentage) {
            var range = timeline.getWindow();
            var interval = range.end - range.start;

            timeline.setWindow({
                start: range.start.valueOf() - interval * percentage,
                end: range.end.valueOf() - interval * percentage
            });
        }

        runPreset(0);

        document.getElementById('zoomIn').onclick = function () { timeline.zoomIn(1); };
        document.getElementById('zoomOut').onclick = function () { timeline.zoomOut(1); };
        document.getElementById('moveLeft').onclick = function () { move(0.2); };
        document.getElementById('moveRight').onclick = function () { move(-0.2); };


        $.ajax({
            type: "GET",
            url: '/api/EventType',
            dataType: 'json',
            contentType: 'application/json',
            success: function (data) {
                var html = eventTypeTemplate({ eventTypes: data });
                $('#event-type-list').html(html);
            }
        });

    </script>

